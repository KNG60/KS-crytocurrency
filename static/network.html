<!DOCTYPE html>
<html>
<head>
    <title>Network Visualization</title>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }

        #network {
            width: 100%;
            height: 600px;
            border: 1px solid #ccc;
        }

        h1 {
            margin-top: 0;
        }

        .legend {
            margin-top: 20px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 5px;
        }

        .legend-item {
            display: inline-block;
            margin-right: 20px;
        }

        .legend-color {
            display: inline-block;
            width: 20px;
            height: 3px;
            margin-right: 5px;
            vertical-align: middle;
        }

        #node-popup {
            display: none;
            position: fixed;
            background: white;
            border: 2px solid #333;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            min-width: 350px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        #node-popup h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
        }

        #node-popup button {
            margin-top: 10px;
            padding: 8px 16px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        #node-popup button:hover:not(:disabled) {
            background: #45a049;
        }

        #node-popup button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        #node-popup .close-btn {
            position: absolute;
            top: 5px;
            right: 10px;
            background: none;
            color: #333;
            font-size: 20px;
            padding: 0;
            margin: 0;
            width: 25px;
            height: 25px;
        }

        #node-popup .close-btn:hover {
            background: none;
            color: #f00;
        }

        #node-popup .button-container {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        #node-popup .button-container button {
            flex: 1;
            margin-top: 0;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4CAF50;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 5px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        .expandable-section {
            margin: 10px 0;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .expandable-header {
            cursor: pointer;
            font-weight: bold;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .expandable-header:hover {
            background: #f0f0f0;
            padding: 5px;
            margin: -5px;
            border-radius: 3px;
        }

        .expandable-content {
            display: none;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
            max-height: 300px;
            overflow-y: auto;
        }

        .expandable-content.expanded {
            display: block;
        }

        .block-item, .tx-item {
            background: white;
            padding: 8px;
            margin: 5px 0;
            border-radius: 3px;
            border: 1px solid #e0e0e0;
            font-size: 12px;
        }

        .block-item strong, .tx-item strong {
            color: #333;
        }

        .json-value {
            color: #0066cc;
            font-family: monospace;
            word-break: break-all;
        }

        .arrow {
            transition: transform 0.3s;
        }

        .arrow.expanded {
            transform: rotate(90deg);
        }

        .transaction-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #ddd;
        }

        .transaction-section h4 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #333;
        }

        .transaction-section select,
        .transaction-section input {
            width: 100%;
            margin: 5px 0 10px 0;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 13px;
            box-sizing: border-box;
        }

        .transaction-section button {
            width: 100%;
            padding: 10px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 13px;
        }

        .transaction-section button:hover {
            background: #0b7dda;
        }

        .transaction-section label {
            display: block;
            font-weight: bold;
            font-size: 12px;
            margin-bottom: 3px;
        }
    </style>
</head>
<body>
<h1>Network Topology</h1>
<div id="network"></div>
<div id="node-popup">
    <button class="close-btn" onclick="closePopup()">√ó</button>
    <h3 id="popup-title">Node Info</h3>
    <div id="popup-content"></div>
    <div class="button-container">
        <button id="mine-btn" onclick="mineBlock()">Mine Block</button>
    </div>
</div>
<div class="legend">
    <div class="legend-item">
        <span class="legend-color" style="background: #97c2fc;"></span>
        <span>Normal Node</span>
    </div>
    <div class="legend-item">
        <span style="display: inline-block; width: 20px; height: 20px; background: #FFD700; border: 2px solid #FF9800; margin-right: 5px; vertical-align: middle;"></span>
        <span>Miner Node</span>
    </div>
    <div class="legend-item">
        <span class="legend-color" style="background: #888;"></span>
        <span>Inactive Node</span>
    </div>
</div>

<script>
    const container = document.getElementById('network');
    let network = null;
    let currentNodeData = null;
    let nodesData = [];

    function getWalletLabelFromPort(port) {
        const portNum = parseInt(port);
        const nodeIndex = portNum - 5000;
        return `node_${nodeIndex}`;
    }

    let previousBalances = {};
    let publicKeyToLabelMap = {};
    let animatingNodes = new Set();

    const options = {
        nodes: {
            shape: 'dot',
            size: 20,
            font: {size: 14}
        },
        edges: {
            smooth: {type: 'continuous'}
        },
        layout: {
            randomSeed: 1
        },
        physics: {
            enabled: true,
            stabilization: {
                enabled: true,
                iterations: 200
            }
        }
    };

    function showPopup(nodeId, x, y) {
        const popup = document.getElementById('node-popup');
        const node = nodesData.find(n => n.id === nodeId);

        if (!node) return;

        const port = nodeId.split(':')[1];

        popup.style.display = 'block';
        popup.style.left = `${x + 10}px`;
        popup.style.top = `${y + 10}px`;

        document.getElementById('popup-title').textContent = `Node: ${port} (Loading...)`;
        document.getElementById('popup-content').innerHTML = '<div style="text-align: center; padding: 20px;"><span class="spinner"></span> Loading...</div>';

        const info = node.info || {};
        const chain = info.chain || [];
        const pendingTransactions = info.pending_transactions || [];
        const publicKey = info.public_key;
        const balance = info.balance !== undefined ? info.balance : '?';
        const role = info.role || 'normal';

        currentNodeData = {
            id: nodeId,
            info: info
        };

        if (publicKey) {
            publicKeyToLabelMap[publicKey] = getWalletLabelFromPort(parseInt(port));
        }

        document.getElementById('popup-title').textContent = `Node: ${port} ${role === 'miner' ? '‚õè' : ''}`;

        let content = '';
        content += `<div class="info-row"><span class="info-label">Port:</span>${port}</div>`;
        content += `<div class="info-row"><span class="info-label">Role:</span>${role === 'miner' ? 'Miner ‚õè' : 'Normal'}</div>`;
        content += `<div class="info-row"><span class="info-label">Balance:</span>${balance}</div>`;

        if (publicKey) {
            content += `<div class="info-row"><span class="info-label">Public Key:</span><span class="json-value">${publicKey.substring(0, 30)}...</span></div>`;
        }

        const chainLength = chain.length;
        content += `
            <div class="expandable-section">
                <div class="expandable-header" onclick="toggleSection('chain-section')">
                    <span>Blockchain (${chainLength} blocks)</span>
                    <span class="arrow" id="chain-arrow">‚ñ∂</span>
                </div>
                <div class="expandable-content" id="chain-section">
                    ${renderBlockchain(chain)}
                </div>
            </div>
        `;

        const pendingTxCount = pendingTransactions.length;
        content += `
            <div class="expandable-section">
                <div class="expandable-header" onclick="toggleSection('tx-section')">
                    <span>Pending Transactions (${pendingTxCount})</span>
                    <span class="arrow" id="tx-arrow">‚ñ∂</span>
                </div>
                <div class="expandable-content" id="tx-section">
                    ${renderTransactions(pendingTransactions)}
                </div>
            </div>
        `;

        content += `
            <div class="transaction-section">
                <h4>üí∏ Send Transaction</h4>
                <label>Recipient Node:</label>
                <select id="tx-recipient-select">
                    <option value="">-- Select recipient --</option>
                </select>
                <label>Amount:</label>
                <input type="number" id="tx-amount-input" placeholder="Enter amount" min="0" step="0.01">
                <button onclick="createTransaction()">Create Transaction</button>
            </div>
        `;

        document.getElementById('popup-content').innerHTML = content;

        const recipientSelect = document.getElementById('tx-recipient-select');
        nodesData.forEach(n => {
            if (n.id !== nodeId) {
                const option = document.createElement('option');
                option.value = n.id;
                const optPort = n.id.split(':')[1];
                const optRole = n.info?.role === 'miner' ? ' ‚õè' : '';
                option.textContent = `Node ${optPort}${optRole}`;
                recipientSelect.appendChild(option);
            }
        });

        const mineBtn = document.getElementById('mine-btn');

        if (role === 'miner') {
            mineBtn.disabled = false;
            mineBtn.style.display = 'block';
            mineBtn.innerHTML = 'Mine Block';
        } else {
            mineBtn.style.display = 'none';
        }
    }

    function toggleSection(sectionId) {
        const section = document.getElementById(sectionId);
        const arrowId = sectionId.replace('-section', '-arrow');
        const arrow = document.getElementById(arrowId);

        section.classList.toggle('expanded');
        if (arrow) {
            arrow.classList.toggle('expanded');
        }
    }

    function buildPublicKeyToLabelMap(nodes) {
        publicKeyToLabelMap = {};
        nodes.forEach(node => {
            if (node.info && node.info.public_key) {
                const port = node.id.split(':')[1];
                publicKeyToLabelMap[node.info.public_key] = getWalletLabelFromPort(parseInt(port));
            }
        });
    }

    function formatPublicKeyWithLabel(publicKey) {
        if (!publicKey) return 'Unknown';

        const label = publicKeyToLabelMap[publicKey];
        const shortKey = publicKey.substring(0, 16) + '...';

        if (label) {
            return `<strong>${label}</strong> (${shortKey})`;
        }
        return shortKey;
    }

    function renderBlockchain(chain) {
        if (!chain || chain.length === 0) {
            return '<div style="color: #888; font-style: italic;">No blocks</div>';
        }

        let html = '';
        chain.forEach((block) => {
            const txCount = block.txs ? block.txs.length : 0;

            html += `
                <div class="block-item">
                    <strong>Block #${block.height}</strong><br>
                    <strong>Hash:</strong> <span class="json-value">${block.hash.substring(0, 16)}...</span><br>
                    <strong>Prev Hash:</strong> <span class="json-value">${block.prev_hash.substring(0, 16)}...</span><br>
                    <strong>Miner:</strong> ${formatPublicKeyWithLabel(block.miner)}<br>
                    <strong>Nonce:</strong> ${block.nonce}<br>
                    <strong>Timestamp:</strong> ${new Date(block.timestamp * 1000).toLocaleString()}<br>
                    <strong>Transactions (${txCount}):</strong>
            `;

            if (txCount > 0) {
                html += '<div style="margin-left: 15px; margin-top: 5px; padding-left: 10px; border-left: 2px solid #ddd;">';
                block.txs.forEach((tx, txIndex) => {
                    const isCoinbase = !tx.sender || tx.sender === 'COINBASE';
                    html += `
                        <div style="margin: 8px 0; padding: 5px; background: #fafafa; border-radius: 3px; font-size: 11px;">
                            <strong style="color: ${isCoinbase ? '#4CAF50' : '#2196F3'};">
                                ${isCoinbase ? '‚õè Coinbase' : 'üí∏ TX'} #${txIndex + 1}
                            </strong><br>
                            <strong>TXID:</strong> <span class="json-value">${tx.txid.substring(0, 12)}...</span><br>
                            ${!isCoinbase ? `<strong>From:</strong> ${formatPublicKeyWithLabel(tx.sender)}<br>` : ''}
                            <strong>To:</strong> ${formatPublicKeyWithLabel(tx.recipient)}<br>
                            <strong>Amount:</strong> <span style="color: #f57c00;">${tx.amount}</span><br>
                            <strong>Time:</strong> ${new Date(tx.timestamp * 1000).toLocaleTimeString()}<br>
                            <strong>Signature:</strong> <span class="json-value" style="font-size: 10px;">${tx.signature.substring(0, 20)}...</span>
                        </div>
                    `;
                });
                html += '</div>';
            } else {
                html += ' <span style="color: #888; font-style: italic;">No transactions</span>';
            }

            html += `</div>`;
        });

        return html;
    }

    function renderTransactions(transactions) {
        if (!transactions || transactions.length === 0) {
            return '<div style="color: #888; font-style: italic;">No pending transactions</div>';
        }

        let html = '';
        transactions.forEach((tx) => {
            const isCoinbase = !tx.sender || tx.sender === 'COINBASE';
            html += `
                <div class="tx-item">
                    <strong>${isCoinbase ? 'Coinbase Transaction' : 'Transaction'}</strong><br>
                    <strong>TXID:</strong> <span class="json-value">${tx.txid.substring(0, 16)}...</span><br>
                    ${!isCoinbase ? `<strong>From:</strong> ${formatPublicKeyWithLabel(tx.sender)}<br>` : ''}
                    <strong>To:</strong> ${formatPublicKeyWithLabel(tx.recipient)}<br>
                    <strong>Amount:</strong> ${tx.amount}<br>
                    <strong>Timestamp:</strong> ${new Date(tx.timestamp * 1000).toLocaleString()}<br>
                    ${tx.signature ? `<strong>Signature:</strong> <span class="json-value">${tx.signature.substring(0, 20)}...</span>` : ''}
                </div>
            `;
        });

        return html;
    }

    function closePopup() {
        document.getElementById('node-popup').style.display = 'none';
        currentNodeData = null;
    }

    function createTransaction() {
        if (!currentNodeData) return;

        const recipientId = document.getElementById('tx-recipient-select').value;
        const amount = parseFloat(document.getElementById('tx-amount-input').value);

        if (!recipientId) {
            alert('Please select a recipient node');
            return;
        }

        if (!amount || amount <= 0) {
            alert('Please enter a valid amount');
            return;
        }

        const senderPort = currentNodeData.id.split(':')[1];
        const recipientPort = recipientId.split(':')[1];
        const senderWallet = getWalletLabelFromPort(parseInt(senderPort));
        const recipientWallet = getWalletLabelFromPort(parseInt(recipientPort));

        const command = `python run_wallet.py create-tx ${senderWallet} ${recipientWallet} ${amount} --node http://127.0.0.1:${senderPort}`;

        const textarea = document.createElement('textarea');
        textarea.value = command;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);

        alert(`Transaction command copied to clipboard!\n\nRun this command in terminal:\n${command}`);

        document.getElementById('tx-recipient-select').value = '';
        document.getElementById('tx-amount-input').value = '';
    }

    function mineBlock() {
        if (!currentNodeData) return;

        const mineBtn = document.getElementById('mine-btn');
        const port = currentNodeData.id.split(':')[1];

        mineBtn.disabled = true;
        mineBtn.innerHTML = '<span class="spinner"></span>Mining...';

        fetch(`http://127.0.0.1:${port}/mine`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        throw new Error(errorData.error || `HTTP ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(() => {
                mineBtn.innerHTML = 'Mine Block';
                mineBtn.disabled = false;
                closePopup();
            })
            .catch(error => {
                console.error('Failed to mine block:', error);
                alert(`Failed to mine block: ${error.message}`);
                mineBtn.innerHTML = 'Mine Block';
                mineBtn.disabled = false;
            });
    }

    function animateBalanceChange(nodeId) {
        if (!network) return;

        animatingNodes.add(nodeId);
        const nodes = network.body.data.nodes;
        const node = nodes.get(nodeId);
        if (node) {
            nodes.update({
                id: nodeId,
                color: {
                    background: '#4CAF50',
                    border: '#2E7D32',
                },
                borderWidth: 4
            });

            setTimeout(() => {
                const isMiner = nodesData.find(n => n.id === nodeId)?.info?.role === 'miner';
                nodes.update({
                    id: nodeId,
                    color: isMiner ? {background: '#FFD700', border: '#FF9800'} : {
                        background: '#97c2fc',
                        border: '#2B7CE9'
                    },
                    borderWidth: isMiner ? 3 : 1
                });
                animatingNodes.delete(nodeId);
            }, 2000);
        }
    }

    function updateNetwork(data) {
        nodesData = data.nodes || [];

        buildPublicKeyToLabelMap(nodesData);

        nodesData.forEach(node => {
            const nodeId = node.id;
            const currentBalance = node.info?.balance;

            if (previousBalances[nodeId] !== undefined &&
                currentBalance !== undefined &&
                previousBalances[nodeId] !== currentBalance) {
                setTimeout(() => animateBalanceChange(nodeId), 100);
            }

            if (currentBalance !== undefined) {
                previousBalances[nodeId] = currentBalance;
            }
        });

        const processedNodes = nodesData.map(node => {
            const isMiner = node.info?.role === 'miner';
            const processedNode = {...node};

            if (isMiner) {
                processedNode.shape = 'box';
                processedNode.color = {
                    background: '#FFD700',
                    border: '#FF9800'
                };
                processedNode.borderWidth = 3;
            } else {
                processedNode.shape = 'dot';
                processedNode.color = {
                    background: '#97c2fc',
                    border: '#2B7CE9'
                };
                processedNode.borderWidth = 1;
            }

            return processedNode;
        });

        if (!network) {
            const graphData = {
                nodes: new vis.DataSet(processedNodes),
                edges: new vis.DataSet(data.edges)
            };

            network = new vis.Network(container, graphData, options);

            network.on('click', function (params) {
                if (params.nodes.length > 0) {
                    const nodeId = params.nodes[0];
                    const position = params.pointer.DOM;
                    showPopup(nodeId, position.x, position.y);
                } else {
                    closePopup();
                }
            });
        } else {
            const currentNodes = network.body.data.nodes;
            const currentEdges = network.body.data.edges;

            processedNodes.forEach(node => {
                const existingNode = currentNodes.get(node.id);
                if (existingNode) {
                    if (!animatingNodes.has(node.id)) {
                        currentNodes.update(node);
                    }
                } else {
                    currentNodes.add(node);
                }
            });

            const newEdgeIds = new Set(data.edges.map(e => `${e.from}-${e.to}`));
            const existingEdgeIds = currentEdges.getIds();

            data.edges.forEach(edge => {
                const edgeId = `${edge.from}-${edge.to}`;

                const exists = existingEdgeIds.some(id => {
                    const existingEdge = currentEdges.get(id);
                    return (existingEdge.from === edge.from && existingEdge.to === edge.to) ||
                        (existingEdge.from === edge.to && existingEdge.to === edge.from);
                });

                if (!exists) {
                    currentEdges.add({...edge, id: edgeId});
                }
            });

            existingEdgeIds.forEach(id => {
                const edge = currentEdges.get(id);
                const edgeId = `${edge.from}-${edge.to}`;
                const reverseEdgeId = `${edge.to}-${edge.from}`;

                if (!newEdgeIds.has(edgeId) && !newEdgeIds.has(reverseEdgeId)) {
                    currentEdges.remove(id);
                }
            });

        }
    }

    fetch('http://127.0.0.1:8080/network-graph')
        .then(response => response.json())
        .then(data => {
            updateNetwork(data);
        })
        .catch(error => {
            console.error('Failed to load initial data:', error);
        });

    const eventSource = new EventSource('http://127.0.0.1:8080/network-stream');

    eventSource.onmessage = (event) => {
        const data = JSON.parse(event.data);

        updateNetwork(data);
    };

    eventSource.onerror = (error) => {
        console.error('SSE error:', error);
    };
</script>
</body>
</html>

